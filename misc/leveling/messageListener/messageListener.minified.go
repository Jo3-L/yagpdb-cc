{{$f:=0}}{{$b:=sdict "type" "stack"}}{{with (dbGet 0 "xpSettings")}}{{$f =sdict .Value}}{{end}}{{with (dbGet 0 "roleRewards")}}{{$b =sdict .Value}}{{end}}{{$g:=false}}{{if (dbGet .User.ID "xpCooldown")}}{{$g =true}}{{end}}{{if and (not $g) $f}}{{$d:=randInt $f.min $f.max}}{{$e:=0}}{{with (dbGet .User.ID "xp")}}{{$e =.Value}}{{end}}{{$c:=roundFloor (mult 0.1 (sqrt $e))}}{{$k:=dbIncr .User.ID "xp" $d}}{{$i:=roundFloor (mult 0.1 (sqrt $k))}}{{$h:=or $f.channel .Channel.ID}}{{if not (getChannel $h)}}{{$h =.Channel.ID}}{{end}}{{if ne $i $c}}{{$n:=$b.type}}{{$l:=or ($b.Get (json $i)) 0}}{{range $level, $j:=$b}}{{if and (ge (toInt $i) (toInt $level)) (not (hasRoleID $j)) (eq $n "stack") (ne $level "type")}}{{addRoleID $j}}{{else if and (hasRoleID $j) (eq $n "highest") $l}}{{removeRoleID $j}}{{end}}{{end}}{{if $l}}{{addRoleID $l}}{{end}}{{$m:=cembed 
"title" "‚ùØ Level up!"
"thumbnail" (sdict "url" "https://webstockreview.net/images/emoji-clipart-celebration-4.png")
"description" (printf "Congratulations **%s**! You've leveled up to level %d - keep it up!" .User.String (toInt $i))
"color" 14232643}}{{sendMessage $h (complexMessage "content" .User.Mention "embed" $m)}}{{end}}{{$a:=div $f.cooldown 1000000000}}{{dbSetExpire .User.ID "xpCooldown" true $a}}{{end}}
